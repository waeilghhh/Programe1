<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>موقع العرض - إدارة العملاء</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #4a89dc 0%, #3b7bc9 100%);
            color: white;
            padding: 1.5rem;
            text-align: center;
            border-radius: 10px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .stats-toggle {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            text-decoration: none;
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }
        
        .stats-toggle:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.05);
        }
        
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
        }
        
        .search-container input {
            flex: 1;
            min-width: 250px;
            padding: 12px 45px 12px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
        }
        
        .search-container input:focus {
            outline: none;
            border-color: #4a89dc;
            box-shadow: 0 2px 12px rgba(74, 137, 220, 0.2);
        }
        
        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            background-color: white;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-btn.active {
            background-color: #4a89dc;
            color: white;
        }
        
        .filter-btn:hover {
            background-color: #e9e9e9;
        }
        
        .filter-btn.active:hover {
            background-color: #3b7bc9;
        }
        
        .tabs-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 16px 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            background-color: rgba(74, 137, 220, 0.1);
            color: #4a89dc;
            border-bottom: 3px solid #4a89dc;
            font-weight: 600;
        }
        
        .tab:hover:not(.active) {
            background-color: #f8f9fa;
        }
        
        .tab i {
            font-size: 1.1rem;
        }
        
        .stats-container {
            display: none;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }
        
        .stats-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s;
            border-left: 4px solid #4a89dc;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            color: #4a89dc;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #777;
            font-size: 0.9rem;
        }
        
        .recent-activity {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .activity-list {
            list-style: none;
            padding: 0;
        }
        
        .activity-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(74, 137, 220, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4a89dc;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            padding: 25px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
            border-top: 5px solid #4a89dc;
        }
        
        .card:hover {
            transform: translateY(-7px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card h3 {
            color: #4a89dc;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card p {
            margin-bottom: 12px;
            color: #555;
        }
        
        .card strong {
            color: #333;
        }
        
        .card a {
            display: inline-block;
            background-color: #4a89dc;
            color: white;
            padding: 8px 16px;
            text-decoration: none;
            border-radius: 30px;
            transition: background-color 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .card a:hover {
            background-color: #3b7bc9;
            transform: translateY(-2px);
        }
        
        .card-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .card-btn {
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .delete-btn {
            background-color: #e74c3c;
        }
        
        .delete-btn:hover {
            background-color: #c0392b;
        }
        
        .move-btn {
            background-color: #f39c12;
        }
        
        .move-btn:hover {
            background-color: #e67e22;
        }
        
        .confirm-btn {
            background-color: #2ecc71;
        }
        
        .confirm-btn:hover {
            background-color: #27ae60;
        }
        
        .cancel-btn {
            background-color: #e74c3c;
        }
        
        .cancel-btn:hover {
            background-color: #c0392b;
        }
        
        .unavailable-btn {
            background-color: #95a5a6;
        }
        
        .unavailable-btn:hover {
            background-color: #7f8c8d;
        }
        
        .move-select {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 30px;
            margin-right: 10px;
            background-color: #f8f9fa;
        }
        
        .move-select-btn {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .move-select-btn:hover {
            background-color: #8e44ad;
            transform: translateY(-2px);
        }
        
        .toast {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 15px 25px;
            background-color: #333;
            color: white;
            border-radius: 8px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast.show {
            opacity: 1;
        }
        
        .toast.success {
            background-color: #2ecc71;
        }
        
        .toast.error {
            background-color: #e74c3c;
        }
        
        .toast.warning {
            background-color: #f39c12;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            color: #777;
            border-top: 1px solid #eee;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #777;
            grid-column: 1 / -1;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
            
            .tabs-container {
                flex-direction: column;
            }
            
            .tab {
                min-width: 100%;
                justify-content: flex-start;
                padding: 15px 20px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .card-actions {
                flex-direction: column;
            }
            
            .card-actions button, .card-actions select {
                width: 100%;
                margin-bottom: 8px;
            }
            
            .stats-toggle {
                position: static;
                margin-top: 15px;
                transform: none;
                display: inline-flex;
                justify-content: center;
            }
            
            .search-container input {
                padding: 12px 15px 12px 40px;
            }
            
            .search-icon {
                left: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-users-cog"></i> إدارة العملاء</h1>
            <div class="stats-toggle" id="statsToggle">
                <i class="fas fa-chart-bar"></i>
                <span>عرض الإحصائيات</span>
            </div>
        </header>
        
        <!-- قسم الإحصائيات -->
        <div class="stats-container" id="statsContainer">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">إجمالي العملاء</div>
                    <div class="stat-number" id="totalClients">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">العملاء الحاليين</div>
                    <div class="stat-number" id="activeClients">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">قائمة الانتظار</div>
                    <div class="stat-number" id="pendingClients">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">تم التأكيد</div>
                    <div class="stat-number" id="confirmedClients">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">ملغية</div>
                    <div class="stat-number" id="cancelledClients">0</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">غير متاحة</div>
                    <div class="stat-number" id="unavailableClients">0</div>
                </div>
            </div>
            
            <div class="recent-activity">
                <h2><i class="fas fa-history"></i> أحدث العملاء</h2>
                <ul class="activity-list" id="recentActivity">
                    <!-- سيتم ملء هذا القسم بالبيانات -->
                </ul>
            </div>
        </div>
        
        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" id="globalSearchInput" placeholder="ابحث في جميع العملاء...">
        </div>
        
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">
                <i class="fas fa-layer-group"></i> الكل
            </button>
            <button class="filter-btn" data-filter="today">
                <i class="fas fa-calendar-day"></i> اليوم
            </button>
            <button class="filter-btn" data-filter="week">
                <i class="fas fa-calendar-week"></i> أسبوع
            </button>
            <button class="filter-btn" data-filter="month">
                <i class="fas fa-calendar-alt"></i> شهر
            </button>
        </div>
        
        <div class="tabs-container">
            <div class="tab active" data-tab="active">
                <i class="fas fa-users"></i> العملاء
            </div>
            <div class="tab" data-tab="pending">
                <i class="fas fa-list"></i> قائمة الانتظار
            </div>
            <div class="tab" data-tab="confirmed">
                <i class="fas fa-check-circle"></i> تم تاكيد
            </div>
            <div class="tab" data-tab="cancelled">
                <i class="fas fa-times-circle"></i> ملغية
            </div>
            <div class="tab" data-tab="unavailable">
                <i class="fas fa-user-slash"></i> غير متاحة
            </div>
        </div>
        
        <div class="cards-container" id="cardsContainer">
            <!-- سيتم ملء هذا القسم بالبيانات من Firebase -->
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    
    <footer>
        <p>جميع الحقوق محفوظة &copy; 2023</p>
    </footer>

    <!-- إضافة Firebase SDK v9 -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, doc, deleteDoc, addDoc, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD-2XyDdRd96bMkeSczg8VjSjmU04Zlv28",
            authDomain: "waeilstore-88caa.firebaseapp.com",
            projectId: "waeilstore-88caa",
            storageBucket: "waeilstore-88caa.firebasestorage.app",
            messagingSenderId: "688527524354",
            appId: "1:688527524354:web:f52aadb38528c6ea419d1b",
            measurementId: "G-GZ1VJBD3RR"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // تعريف المتغيرات العامة
        let currentTab = 'active';
        let allItems = [];
        let currentFilter = 'all';
        let showStats = false;
        
        // عرض Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i> ${message}`;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, 3000);
        }
        
        // تأكيد الإجراءات
        function confirmAction(action, callback) {
            if (confirm(`هل أنت متأكد من ${action}؟`)) {
                callback();
            }
        }
        
        // تحميل البيانات حسب التبويب المحدد
        async function loadData() {
            const cardsContainer = document.getElementById('cardsContainer');
            
            try {
                let collectionName;
                switch(currentTab) {
                    case 'active': collectionName = 'items'; break;
                    case 'pending': collectionName = 'pendingItems'; break;
                    case 'confirmed': collectionName = 'confirmedItems'; break;
                    case 'cancelled': collectionName = 'cancelledItems'; break;
                    case 'unavailable': collectionName = 'unavailableItems'; break;
                    default: collectionName = 'items';
                }
                
                const q = query(collection(db, collectionName), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                cardsContainer.innerHTML = ''; // مسح المحتوى الحالي
                allItems = [];
                
                if (querySnapshot.empty) {
                    cardsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>لا توجد عناصر لعرضها حالياً</h3>
                            <p>لم يتم إضافة أي عملاء في هذه الفئة بعد</p>
                        </div>
                    `;
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    const itemData = {
                        id: doc.id,
                        name: data.name || 'بدون اسم',
                        number: data.number || 'غير محدد',
                        product: data.product || 'غير محدد',
                        details: data.details || 'لا توجد تفاصيل',
                        url: data.url || '',
                        timestamp: data.timestamp,
                        collection: collectionName
                    };
                    
                    allItems.push(itemData);
                    
                    const card = document.createElement('div');
                    card.className = 'card';
                    if (itemData.timestamp) {
                        card.setAttribute('data-timestamp', itemData.timestamp.toDate().getTime());
                    }
                    
                    let actionButtons = '';
                    
                    // إضافة أزرار حسب نوع التبويب
                    if (currentTab === 'active') {
                        actionButtons = `
                            <button class="card-btn move-btn" data-id="${doc.id}">
                                <i class="fas fa-exchange-alt"></i> نقل إلى الانتظار
                            </button>
                            <button class="card-btn confirm-btn" data-id="${doc.id}">
                                <i class="fas fa-check"></i> تأكيد
                            </button>
                            <button class="card-btn cancel-btn" data-id="${doc.id}">
                                <i class="fas fa-times"></i> إلغاء
                            </button>
                            <button class="card-btn unavailable-btn" data-id="${doc.id}">
                                <i class="fas fa-user-slash"></i> غير متاح
                            </button>
                        `;
                    } else if (currentTab === 'pending') {
                        actionButtons = `
                            <button class="card-btn move-btn" data-id="${doc.id}">
                                <i class="fas fa-exchange-alt"></i> نقل إلى العملاء
                            </button>
                            <button class="card-btn confirm-btn" data-id="${doc.id}">
                                <i class="fas fa-check"></i> تأكيد
                            </button>
                            <button class="card-btn cancel-btn" data-id="${doc.id}">
                                <i class="fas fa-times"></i> إلغاء
                            </button>
                            <button class="card-btn unavailable-btn" data-id="${doc.id}">
                                <i class="fas fa-user-slash"></i> غير متاح
                            </button>
                        `;
                    } else {
                        actionButtons = `
                            <select class="move-select" data-id="${doc.id}">
                                <option value="">اختر الوجهة</option>
                                <option value="items">العملاء</option>
                                <option value="pendingItems">قائمة الانتظار</option>
                                <option value="confirmedItems">تم التأكيد</option>
                                <option value="cancelledItems">ملغية</option>
                                <option value="unavailableItems">غير متاحة</option>
                            </select>
                            <button class="card-btn move-select-btn" data-id="${doc.id}">
                                <i class="fas fa-exchange-alt"></i> نقل
                            </button>
                            <button class="card-btn delete-btn" data-id="${doc.id}">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        `;
                    }
                    
                    card.innerHTML = `
                        <h3>${itemData.name}</h3>
                        <p><strong>الرقم:</strong> ${itemData.number}</p>
                        <p><strong>المنتج/الخدمة:</strong> ${itemData.product}</p>
                        <p><strong>التفاصيل:</strong> ${itemData.details}</p>
                        ${itemData.url ? `<a href="${itemData.url}" target="_blank"><i class="fas fa-link"></i> زيارة الرابط</a>` : ''}
                        <div class="card-actions">
                            ${actionButtons}
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                });
                
                // تطبيق الفلترة الحالية
                applyFilter(currentFilter);
                
                // إضافة مستمعي الأحداث للأزرار
                addEventListeners();
                
                // تحميل الإحصائيات إذا كانت معروضة
                if (showStats) {
                    loadStats();
                }
                
            } catch (error) {
                console.error("Error getting documents: ", error);
                cardsContainer.innerHTML = '<p>حدث خطأ في تحميل البيانات</p>';
                showToast('حدث خطأ في تحميل البيانات', 'error');
            }
        }
        
        // تحميل الإحصائيات
        async function loadStats() {
            try {
                const collections = ['items', 'pendingItems', 'confirmedItems', 'cancelledItems', 'unavailableItems'];
                const stats = {
                    total: 0,
                    items: 0,
                    pendingItems: 0,
                    confirmedItems: 0,
                    cancelledItems: 0,
                    unavailableItems: 0
                };
                
                // جلب الإحصائيات من جميع المجموعات
                for (const collectionName of collections) {
                    const q = query(collection(db, collectionName));
                    const querySnapshot = await getDocs(q);
                    
                    stats[collectionName] = querySnapshot.size;
                    stats.total += querySnapshot.size;
                }
                
                // عرض الإحصائيات
                document.getElementById('totalClients').textContent = stats.total;
                document.getElementById('activeClients').textContent = stats.items;
                document.getElementById('pendingClients').textContent = stats.pendingItems;
                document.getElementById('confirmedClients').textContent = stats.confirmedItems;
                document.getElementById('cancelledClients').textContent = stats.cancelledItems;
                document.getElementById('unavailableClients').textContent = stats.unavailableItems;
                
                // جلب أحدث العملاء
                await loadRecentActivity();
                
            } catch (error) {
                console.error("Error loading statistics: ", error);
            }
        }
        
        // تحميل أحدث العملاء
        async function loadRecentActivity() {
            try {
                const activityList = document.getElementById('recentActivity');
                activityList.innerHTML = '';
                
                // جلب أحدث 10 عملاء من جميع المجموعات
                let allClients = [];
                const collections = ['items', 'pendingItems', 'confirmedItems', 'cancelledItems', 'unavailableItems'];
                
                for (const collectionName of collections) {
                    const q = query(collection(db, collectionName), orderBy("timestamp", "desc"), limit(5));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allClients.push({
                            name: data.name || 'بدون اسم',
                            product: data.product || 'غير محدد',
                            timestamp: data.timestamp,
                            status: collectionName
                        });
                    });
                }
                
                // ترتيب حسب التاريخ
                allClients.sort((a, b) => {
                    if (!a.timestamp || !b.timestamp) return 0;
                    return b.timestamp.seconds - a.timestamp.seconds;
                });
                
                // عرض أحدث 10 عملاء
                const recentClients = allClients.slice(0, 10);
                
                if (recentClients.length === 0) {
                    activityList.innerHTML = '<li>لا توجد أنشطة حديثة</li>';
                    return;
                }
                
                recentClients.forEach(client => {
                    const li = document.createElement('li');
                    li.className = 'activity-item';
                    
                    const date = client.timestamp ? new Date(client.timestamp.toDate()).toLocaleDateString('ar-EG') : 'غير معروف';
                    const statusText = getStatusText(client.status);
                    const iconClass = getStatusIcon(client.status);
                    
                    li.innerHTML = `
                        <div class="activity-icon">
                            <i class="${iconClass}"></i>
                        </div>
                        <div>
                            <strong>${client.name}</strong> - ${client.product}
                            <br><small>الحالة: ${statusText} - التاريخ: ${date}</small>
                        </div>
                    `;
                    
                    activityList.appendChild(li);
                });
                
            } catch (error) {
                console.error("Error loading recent activity: ", error);
            }
        }
        
        // الحصول على أيقونة الحالة من اسم المجموعة
        function getStatusIcon(collectionName) {
            const iconMap = {
                'items': 'fas fa-users',
                'pendingItems': 'fas fa-list',
                'confirmedItems': 'fas fa-check-circle',
                'cancelledItems': 'fas fa-times-circle',
                'unavailableItems': 'fas fa-user-slash'
            };
            
            return iconMap[collectionName] || 'fas fa-user';
        }
        
        // الحصول على نص الحالة من اسم المجموعة
        function getStatusText(collectionName) {
            const statusMap = {
                'items': 'العملاء',
                'pendingItems': 'قائمة الانتظار',
                'confirmedItems': 'تم التأكيد',
                'cancelledItems': 'ملغية',
                'unavailableItems': 'غير متاحة'
            };
            
            return statusMap[collectionName] || 'غير معروف';
        }
        
        // تطبيق الفلترة على العناصر
        function applyFilter(filterType) {
            const now = new Date();
            const cards = document.querySelectorAll('.card');
            
            cards.forEach(card => {
                let showCard = true;
                
                if (filterType !== 'all') {
                    const timestamp = card.getAttribute('data-timestamp');
                    if (timestamp) {
                        const itemDate = new Date(parseInt(timestamp));
                        
                        switch(filterType) {
                            case 'today':
                                showCard = itemDate.toDateString() === now.toDateString();
                                break;
                            case 'week':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                showCard = itemDate >= weekAgo;
                                break;
                            case 'month':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                showCard = itemDate >= monthAgo;
                                break;
                        }
                    }
                }
                
                card.style.display = showCard ? 'block' : 'none';
            });
        }
        
        // البحث الشامل في جميع العملاء
        async function globalSearch(searchTerm) {
            if (searchTerm.length < 2) {
                loadData();
                return;
            }
            
            try {
                // جلب البيانات من جميع المجموعات
                const collections = ['items', 'pendingItems', 'confirmedItems', 'cancelledItems', 'unavailableItems'];
                let allClients = [];
                
                for (const collectionName of collections) {
                    const q = query(collection(db, collectionName), orderBy("timestamp", "desc"));
                    const querySnapshot = await getDocs(q);
                    
                    querySnapshot.forEach((doc) => {
                        const data = doc.data();
                        allClients.push({
                            id: doc.id,
                            name: data.name || '',
                            number: data.number || '',
                            product: data.product || '',
                            details: data.details || '',
                            url: data.url || '',
                            timestamp: data.timestamp,
                            collection: collectionName
                        });
                    });
                }
                
                // تصفية النتائج
                const filteredClients = allClients.filter(client => 
                    client.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    client.number.includes(searchTerm) ||
                    client.product.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    client.details.toLowerCase().includes(searchTerm.toLowerCase())
                );
                
                // عرض النتائج
                displaySearchResults(filteredClients);
                
            } catch (error) {
                console.error("Error in global search: ", error);
                showToast('حدث خطأ في البحث', 'error');
            }
        }
        
        // عرض نتائج البحث
        function displaySearchResults(clients) {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';
            
            if (clients.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <h3>لا توجد نتائج للبحث</h3>
                        <p>جرب استخدام كلمات بحث أخرى</p>
                    </div>
                `;
                return;
            }
            
            clients.forEach(client => {
                const card = document.createElement('div');
                card.className = 'card';
                
                card.innerHTML = `
                    <h3>${client.name}</h3>
                    <p><strong>الرقم:</strong> ${client.number}</p>
                    <p><strong>المنتج/الخدمة:</strong> ${client.product}</p>
                    <p><strong>التفاصيل:</strong> ${client.details}</p>
                    <p><strong>الحالة:</strong> ${getStatusText(client.collection)}</p>
                    ${client.url ? `<a href="${client.url}" target="_blank"><i class="fas fa-link"></i> زيارة الرابط</a>` : ''}
                `;
                
                cardsContainer.appendChild(card);
            });
        }
        
        // إضافة مستمعي الأحداث للأزرار
        function addEventListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    confirmAction('حذف هذا العميل', () => deleteItem(itemId));
                });
            });
            
            document.querySelectorAll('.move-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    if (currentTab === 'active') {
                        confirmAction('نقل هذا العميل إلى قائمة الانتظار', () => moveItem(itemId, 'items', 'pendingItems'));
                    } else if (currentTab === 'pending') {
                        confirmAction('نقل هذا العميل إلى العملاء', () => moveItem(itemId, 'pendingItems', 'items'));
                    }
                });
            });
            
            document.querySelectorAll('.confirm-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    confirmAction('تأكيد هذا العميل', () => moveItem(itemId, getCurrentCollection(), 'confirmedItems'));
                });
            });
            
            document.querySelectorAll('.cancel-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    confirmAction('إلغاء هذا العميل', () => moveItem(itemId, getCurrentCollection(), 'cancelledItems'));
                });
            });
            
            document.querySelectorAll('.unavailable-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    confirmAction('وضع هذا العميل كغير متاح', () => moveItem(itemId, getCurrentCollection(), 'unavailableItems'));
                });
            });
            
            document.querySelectorAll('.move-select-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    const select = document.querySelector(`.move-select[data-id="${itemId}"]`);
                    const targetCollection = select.value;
                    
                    if (targetCollection) {
                        confirmAction(`نقل هذا العميل إلى ${getStatusText(targetCollection)}`, () => moveItem(itemId, getCurrentCollection(), targetCollection));
                    }
                });
            });
        }
        
        // الحصول على اسم المجموعة الحالية
        function getCurrentCollection() {
            switch(currentTab) {
                case 'active': return 'items';
                case 'pending': return 'pendingItems';
                case 'confirmed': return 'confirmedItems';
                case 'cancelled': return 'cancelledItems';
                case 'unavailable': return 'unavailableItems';
                default: return 'items';
            }
        }
        
        // حذف عنصر
        async function deleteItem(itemId) {
            try {
                await deleteDoc(doc(db, getCurrentCollection(), itemId));
                showToast('تم حذف العميل بنجاح');
                loadData();
            } catch (error) {
                console.error("Error deleting document: ", error);
                showToast('حدث خطأ أثناء الحذف', 'error');
            }
        }
        
        // نقل عنصر من مجموعة إلى أخرى
        async function moveItem(itemId, sourceCollection, targetCollection) {
            try {
                // البحث عن العنصر في المجموعة المصدر
                const item = allItems.find(item => item.id === itemId);
                
                if (!item) {
                    showToast('لم يتم العثور على العميل', 'error');
                    return;
                }
                
                // إضافة العنصر إلى المجموعة الهدف
                await addDoc(collection(db, targetCollection), {
                    name: item.name,
                    number: item.number,
                    product: item.product,
                    details: item.details,
                    url: item.url,
                    timestamp: serverTimestamp()
                });
                
                // حذف العنصر من المجموعة المصدر
                await deleteDoc(doc(db, sourceCollection, itemId));
                
                showToast(`تم نقل العميل إلى ${getStatusText(targetCollection)} بنجاح`);
                loadData();
                
            } catch (error) {
                console.error("Error moving document: ", error);
                showToast('حدث خطأ أثناء النقل', 'error');
            }
        }
        
        // تهيئة الصفحة
        function init() {
            // تحميل البيانات الأولية
            loadData();
            
            // إضافة مستمعي الأحداث للتبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentTab = this.getAttribute('data-tab');
                    loadData();
                });
            });
            
            // إضافة مستمعي الأحداث لأزرار الفلترة
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.getAttribute('data-filter');
                    applyFilter(currentFilter);
                });
            });
            
            // إضافة مستمع الحدث لعرض/إخفاء الإحصائيات
            document.getElementById('statsToggle').addEventListener('click', function() {
                const statsContainer = document.getElementById('statsContainer');
                showStats = !showStats;
                
                if (showStats) {
                    statsContainer.classList.add('active');
                    this.innerHTML = '<i class="fas fa-times"></i> إخفاء الإحصائيات';
                    loadStats();
                } else {
                    statsContainer.classList.remove('active');
                    this.innerHTML = '<i class="fas fa-chart-bar"></i> عرض الإحصائيات';
                }
            });
            
            // إضافة مستمع الحدث للبحث الشامل
            document.getElementById('globalSearchInput').addEventListener('input', function() {
                globalSearch(this.value);
            });
        }
        
        // بدء التطبيق عند تحميل الصفحة
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>